# Ontology Exchange Docking Document

There are two kinds of assets in ONT: native assets and contract assets. Native assets are ONT and ONG. When docking with the exchange, it mainly processes deposit and withdrawal of these two assets.

The outline of this document is as follows:

* [Ontology Exchange Docking Document](#ontology-exchange-docking-document)
	* [1.Deploy Ontology Synchronization Node](#1deploy-ontology-synchronization-node)
		* [Get from source code](#get-from-source-code)
		* [Get from release](#get-from-release)
		* [Server deployment](#server-deployment)
			* [Create wallet](#create-wallet)
			* [Start up node](#start-up-node)
	* [2. Use CLI Client](#2-use-cli-client)
		* [Security policy](#security-policy)
		* [CLI instruction](#cli-instruction)
			* [Create wallet](#create-wallet)
			* [Generate deposit address](#generate-deposit-address)
	* [3. Process Asset Transactions](#3-process-asset-transactions)
		* [Transaction docking program the exchange needs to develop](#transaction-docking-program-the-exchange-needs-to-develop)
		* [User deposit](#user-deposit)
		* [Deposit record](#deposit-record)
		* [Process user withdrawal request](#process-user-withdrawal-request)
	* [4. Java SDK Tutorials](#4-java-sdk-tutorials)
		* [Account management](#account-management)
			* [Do not use wallet management](#do-not-use-wallet-management)
				* [Create account randomly](#create-account-randomly)
				* [Create account based on private key](#create-account-based-on-private-key)
			* [Use wallet management](#use-wallet-management)
		* [Address generation](#address-generation)
		* [ONT and ONG transfer](#ont-and-ong-transfer)
			* [1. Initialization](#1-initialization)
			* [2. Query](#2-query)
				* [Query ONT, ONG Balance](#query-ont,-ong-balance)
				* [Query whether the transaction is in the transaction pool](#query-whether-the-transaction-is-in-the-transaction-pool)
				* [Query whether the transaction is successful](#query-whether-the-transaction-is-successful)
			* [The list of chain interaction interface](#the-list-of-chain-interaction-interface)
			* [3. ONT transfer](#3-ont-transfer)
				* [Construct transfer transaction and send](#construct-transfer-transaction-and-send)
				* [Multiple signatures](#multiple-signatures)
				* [One to multiple or multiple to multiple](#one-to-multiple-or-multiple-to-multiple)
			* [Use signature server to sign](#use-signature-server-to-sign)
			* [4. ONG transfer](#4-ong-transfer)
				* [ONG transfer](#ong-transfer)
				* [Withdraw ONG](#withdraw-ong)
	* [5. Distribute ONG to Users](#5-distribute-ong-to-users)
		* [What is ONG](#what-is-ong)
		* [Calculate the amount of ONG that can withdraw](#calculate-the-amount-of-ong-that-can-withdraw)
		* [Distribute ONG to users](#distribute-ONG-to-users)
		* [Users withdraw ONG](#users-withdraw-ong)
	* [6. Signature service](#6-signature-service)


## 1.Deploy Ontology Synchronization Node

There are two ways to deploy Ontology synchronization nodes:

### Get from source code

Clone ontology repository to  **$GOPATH/src/github.com/ontio** directory

```
$ git clone https://github.com/ontio/ontology.git
```

Or

```
$ go get github.com/ontio/ontology
```

Use the third-party package management tool glide to manage the dependent libraries

```
$ cd $GOPATH/src/github.com/ontio/ontology
$ glide install
```

Compile source code with make

```
$ make
```

An executable program will be generated after a successful compilation

- `ontology`: Node program/node control program provided by command line

### Get from release

 [release page](https://github.com/ontio/ontology/releases)

### Server deployment

1. #### Create wallet

   - Create the wallet file - wallet.dat that is required for nodes running through the CLI

     ```
     $ ./ontology-linux account add -d
     Use default setting '-t ecdsa -b 256 -s SHA256withECDSA' 
     	signature algorithm: ecdsa 
     	curve: P-256 
     	signature scheme: SHA256withECDSA 
     Password:
     Re-enter Password:

     Index: 1
     Label: 
     Address: TA4fG1ybsg6XHXp6qGymiubG4V1qN9rWRL
     Public key: 120203ac15db156e2af2c6f70b846de387e1dae0cc73a3a489e43db28b17ac7ae07e65
     Signature scheme: SHA256withECDSA

     Create account successfully.
     ```

     ​

   - Directory Structure

     ```
        $ tree
        └── ontology
            ├── ontology
            └── wallet.dat
     ```


2. #### Start up node

   Since the synchronization node only synchronizes the blocks generated by the bookkeeping node and does not participate in the network consensus, the network consensus module can be turned off by the --disableconsensus parameter.

   ```./ontology --disableconsensus```

   By default, the node startup will close the websocket and the rest port. If you want to open above-mentioned ports, you can configure the following parameters:

   ```
   RESTFUL OPTIONS:
     --rest            Enable restful api server
     --restport value  Restful server listening port (default: 20334)
     
   WEB SOCKET OPTIONS:
     --ws            Enable websocket server
     --wsport value  Ws server listening port (default: 20335)
   ```

   ​

## 2. Use CLI Client

### Security policy

Mandatory: The exchange must use a whitelist or firewall to block external server requests, otherwise there will be a serious security risk.

The CLI does not provide remote open/close wallet function and there is no verification process when opening the wallet. Therefore, the security policy needs to be set by the exchange based on its own situation. Since the wallet must remain open in order to process the users' withdrawal, from a security point of view, the wallet must be running on a separate server, and the exchange configures the firewall with reference to the following table.

|               | Mainnet default port |
| ------------- | -------------------- |
| Rest Port     | 20334                |
| Websorcket    | 20335                |
| Json RPC port | 20336                |
| Node port     | 20338                |

### CLI instruction

#### Create wallet

The exchange needs to create an online wallet to manage user deposit address. A wallet is used to store account (including public and private keys), contract address and other information, which is the most important certificate for users to hold assets. It is important to keep wallet files and wallet passwords safe and prevent them from loss or disclosure. The exchange does not need to create a wallet file for each address. Usually a wallet file can store all the user's deposit addresses. You can also use a cold wallet (offline wallet) as a more secure storage.

```
$ ./ontology account add -d
use default value for all options
Enter a password for encrypting the private key:
Re-enter password:

Create account successfully.
Address:  TA9TVuR4Ynn4VotfpExY5SaEy8a99obFPr
Public key: 120202a1cfbe3a0a04183d6c25ceff1e34957ace6e4899e4361c2e1a2bc3c817f90936
Signature scheme: SHA256withECDSA	
```

**The public and private key generation algorithms of ONT are consistent with NEO. The public key addresses of ONT and NEO corresponding to the same private key are the same.**

####  Generate deposit address

A wallet can store multiple addresses, and the exchange needs to generate a deposit address for each user.

There are two ways to generate deposit addresses:

When the user first deposits (ONT/ONG), the program dynamically creates the ONT address. Advantages: No manual creation of addresses is required. Disadvantages: It is inconvenient to back up the wallet.
  
  To create an address dynamically, you can use the Java SDK's implementation and the program will return the created address. Please refer to Java SDK [Create account randomly](#create-account-randomly)

The exchange creates a batch of ONT addresses in advance and assigns the user an ONT address when the user deposits for the first time (ONT/ONG). Advantages: It is easy to back up wallet; disadvantages: Manually create ONT address when the address is insufficient.

  To create a batch of addresses, executing the ./ontology account add -n [n] -w [wallet file] command in the CLI. The -d bracket is an optional parameter and the default value is 1. -w specifies the wallet file and the default file is wallet.dat. For example, to create 100 addresses at one time:

```
$ ./ontology account add -n 100 -d -w wat.dat
Use default setting '-t ecdsa -b 256 -s SHA256withECDSA' 
	signature algorithm: ecdsa 
	curve: P-256 
	signature scheme: SHA256withECDSA 
Password:
Re-enter Password:

Index: 1
Label: 
Address: TA5JtcQC21fLtUy6Eacfkhg8pLEywTv82b
Public key: 120203eaa379d7ca8fdd9705854a72b36b831fb59e0c9cf8863e4bad177d2ad35b90a2
Signature scheme: SHA256withECDSA

Index: 2
Label: 
Address: TA6VB77YfWE7AayMijgzVkaewF8geagja1
Public key: 1202024ee20b5028dbff7d2ab3db47a48bad599cc04b1fb31ff605dc24412415b973ef
Signature scheme: SHA256withECDSA

Index: 3
Label: 
Address: TA5JpD5tTWyyPANxmzvXec1BXUYWpaaGBk
Public key: 120202b8e3f88081d99a88bf019380c27a8da301802157752ed1f8db27e3e108fae0ea
Signature scheme: SHA256withECDSA
....
```



## 3. Process Asset Transactions

### Transaction docking program the exchange needs to develop

1. Monitor new blocks using CLI/API
2. Complete user deposit according to the transaction information 
3. Store transaction records of exchanges

### User deposit

For user deposit, the exchange needs to understand the following:

- In general, due to the different strategies of each exchange, the balance in the exchange's deposit address may not equal to the user's balance in the exchange.

- Ontology address contains ONT and ONG assets. When processing the users' deposit, the exchange needs to judge the asset type so as not to mix up the ONT and ONG deposit.

- The Ontology wallet is a full node. To synchronize the blocks, the wallet needs to be online. You can view the current block height through the CLI command and judge the node status.


  ```
  $ ./ontology info curblockheight
  CurrentBlockHeight:2
  ```

- Transfers between users within the exchange do not need to go through the blockchain, so the exchange can directly modify the users' balance in the database. Only deposit and withdrawal need to go through the blockchain.

Example:

1. A user deposits tokens to the address - ```TA8MoGmzS4T6g3T1CMGEVFiNGkZnn7ixw9```

2. Monitor block information by CLI ```./ontology info block <block number | block hash>```  

   ```
   $ ./ontology info block 209304
   {
      "Hash": "cc92674c0efae4d64e0d974cf4eff78fa9297ca804595d82132afe372ffbc120",
      "Header": {
         "Version": 0,
         "PrevBlockHash": "1c27e93d0079ab701d3dce85edc22dc03c3d6ed58ac733829797a77e657fbead",
         "TransactionsRoot": "f4b39ac8f39e4eb92bbb8cc4f46b427bf68624a225c56fc0fa6310a6012538f0",
         "BlockRoot": "19a65b8fbedc9ebad41d4026e58bcc27a0bed396d95269a27cf1f725ad6a171e",
         "Timestamp": 1528195357,
         "Height": 209304,
         "ConsensusData": 5441406265160202485,
         "ConsensusPayload": "",
         "NextBookkeeper": "TAACeeRwwbHrEZZNCbqFQrNSutcsR3xkK3",
         "Bookkeepers": [
            "120202a76a434b18379e3bda651b7c04e972dadc4760d1156b5c86b3c4d27da48c91a1",
            "12020384d843c02ecef233d3dd3bc266ee0d1a67cf2a1666dc1b2fb455223efdee7452",
            "120203c43f136596ee666416fedb90cde1e0aee59a79ec18ab70e82b73dd297767eddf",
            "120203fab19438e18d8a5bebb6cd3ede7650539e024d7cc45c88b95ab13f8266ce9570"
         ],
         "SigData": [
            "01536b64896f2cd47af30721fad3640980f7ad06042859d75632871735e0fef7d1f404ab0b9904a3c6c67bc9f4887ad663bf7af9bd6239790ab5e1ec1cda7b0066",
            "018367431fb032992cb364df5cd1832c72de63d95d8901e1efadd4271773a4e634697cd33c07c3322dc83a79278112ff9b541e9373651ef96a9415bd547ee113ce",
            "0167b8192cd608bb9589057e87c8da18a32f7aa3664a0790d86d4bbccccd374ce7f092c3521f26ee40dcc91d7a2ad6c23f057f1408d5bf9ba8202165ea8a889653"
         ],
         "Hash": "cc92674c0efae4d64e0d974cf4eff78fa9297ca804595d82132afe372ffbc120"
      },
      "Transactions": [
         {
            "Version": 0,
            "Nonce": 1528195351,
            "GasPrice": 0,
            "GasLimit": 30000,
            "Payer": "0148cb3cb662b84b4bc59bd6e84bafe13b3c0c1f",
            "TxType": 209,
            "Payload": {
               "Code": "00000000000000000000000000000000000000000001087472616e736665722a010148cb3cb662b84b4bc59bd6e84bafe13b3c0c1f01bb163b9224d91160c8fbd65585d3a64c7b1a7f0a",
               "GasLimit": 0,
               "VmType": 255
            },
            "Attributes": [],
            "Sigs": [
               {
                  "PubKeys": [
                     "12020345ed8085fe96f4e816d5d8bda6d387f8df3ab1e52c88548e35315236732d6483"
                  ],
                  "M": 1,
                  "SigData": [
                     "01d2d2587d8c79d5aaef3b43a938a9d60c0eebc898a21df9fc089b2c891a3c553ee855c4f59a38c8f2d649aa1950a12444b39f795bbfbe5d9e69cd57765c7a5619"
                  ]
               }
            ],
            "Hash": "f4b39ac8f39e4eb92bbb8cc4f46b427bf68624a225c56fc0fa6310a6012538f0"
         }
      ]
   }

   ```

3. Get all transaction information in the block according to Transaction Hash by CLI  ```./ontology info status```

```
$ ./ontology info status f4b39ac8f39e4eb92bbb8cc4f46b427bf68624a225c56fc0fa6310a6012538f0
Transaction states:
{
   "TxHash": "f4b39ac8f39e4eb92bbb8cc4f46b427bf68624a225c56fc0fa6310a6012538f0",
   "State": 1,
   "GasConsumed": 0,
   "Notify": [
      {
         "ContractAddress": "0000000000000000000000000000000000000001",
         "States": [
            "transfer",
            "TA5zt4PrSzjWA7DaVHVw2nhxH5ZY9uQiGq",
            "TA8MoGmzS4T6g3T1CMGEVFiNGkZnn7ixw9",
            10
         ]
      }
   ]
}
```

"State" is 1 representing transaction success, and 0 representing the failure

Parse the "Notify" array:

​     ContractAddress: Contract address：	```0000000000000000000000000000000000000001```  is for ONT

​						        ```0000000000000000000000000000000000000002``` is for ONG

​     States：array

​                The first element: "transfer" represents a transfer operation

​		The second element: the from address

​                The third element: the to address

​                The fourth element: the number of transfers （**The actual number of ONT is the number of ONT * 1, and the actual number of ONG is the number of ONG * 10^9**）

To obtain the user's deposit record, you can filter the to address that is generated by the exchange for users. 

### Deposit record

Same as user deposit, the exchange needs to write code to monitor all transactions in all blocks, and record all deposit and withdrawal transactions in the database. If there is a deposit transaction, the exchange needs to modify the corresponding user's balance in the database.



### Process user withdrawal request

With regard to user withdrawal, the exchange needs to complete the following operations:

1. Record user withdrawals and modify users' account balances.

2. Use the CLI command to transfer tokens to the user's withdrawal address:

   ```
   $ ./ontology asset transfer --from TA5zt4PrSzjWA7DaVHVw2nhxH5ZY9uQiGq --to TA8MoGmzS4T6g3T1CMGEVFiNGkZnn7ixw9 --amount 100
   Password:
   Transfer ONT
     From:TA5zt4PrSzjWA7DaVHVw2nhxH5ZY9uQiGq
     To:TA8MoGmzS4T6g3T1CMGEVFiNGkZnn7ixw9
     Amount:100
     TxHash:9863485348031a333681d81e69bc93de66fe93dce3e17cd55a928025a23b512f

   Tip:
     Using './ontology info status 9863485348031a333681d81e69bc93de66fe93dce3e17cd55a928025a23b512f' to query transaction status

   ```

  The list of parameters for the command is as follows:

   --wallet, -w  
   Wallet specifies the wallet path of transfer-out account. The default value is: "./wallet.dat".
   
   --gasprice  
   The gasprice parameter specifies the gas price of the transfer transaction. The gas price of the transaction cannot be less than the lowest gas price set by node's transaction pool, otherwise the transaction will be rejected. The default value is 0. When there are transactions that are queued for packing into the block in the transaction pool, the transaction pool will deal with transactions according to the gas price and transactions with high gas prices will be prioritized. 
   
   --gaslimit  
   The gaslimit parameter specifies the gas limit of the transfer transaction. The gas limit of the transaction cannot be less than the minimum gas limit set by the node's transaction pool, otherwise the transaction will be rejected. Gasprice * gaslimit is actual ONG costs. The default value is 30000.
   
   --asset  
   The asset parameter specifies the asset type of the transfer. Ont indicates the ONT and ong indicates the ONG. The default value is ONT.
   
   --from   
   The from parameter specifies the transfer-out account address.
   
   --to  
   The to parameter specifies the transfer-in account address.
   
   --amount   
   The amount parameter specifies the transfer amount. Note: Since the precision of the ONT is 1, if the input is a floating-point value, then the value of the fractional part will be discarded; the precision of the ONG is 9, so the fractional part beyond 9 bits will be discarded.
   ​

   Confirm the transaction result:

   - Use the returned transaction hash to query directly:

     ```
     ./ontology info status 9863485348031a333681d81e69bc93de66fe93dce3e17cd55a928025a23b512f
     Transaction states:
     {
        "TxHash": "9863485348031a333681d81e69bc93de66fe93dce3e17cd55a928025a23b512f",
        "State": 1,
        "GasConsumed": 0,
        "Notify": [
           {
              "ContractAddress": "0000000000000000000000000000000000000001",
              "States": [
                 "transfer",
                 "TA5zt4PrSzjWA7DaVHVw2nhxH5ZY9uQiGq",
                 "TA8MoGmzS4T6g3T1CMGEVFiNGkZnn7ixw9",
                 100
              ]
           }
        ]
     }

     ```

     ​

   - Same as ”user deposit“, monitor transactions in new blocks and filter out successful transactions which are from exchange addresses to user's withdrawal addresses

3. Extract the transaction ID from the returned transaction details of Json format and record it in the database.

4. Wait for the blockchain confirmation. After confirmation, marking the withdrawal record as successful withdrawal.

   Similar to monitoring the blockchain during deposit, the withdrawal process is also the same. If a certain transaction ID in the block is found to be equal to the transaction ID in the withdrawal record during monitoring, the transaction is confirmed and the withdrawal is successful.

5. If the transaction is not confirmed all the time, that is, the corresponding event log cannot be queried through the transaction hash, then

   - Check if the transaction is in the transaction pool via RPC/SDK interface（refer to[Java SDK:ONT and ONG transfer](https://github.com/ontio/ontology-java-sdk/blob/master/docs/cn/sdk_get_start.md#2-%E5%8E%9F%E7%94%9F%E8%B5%84%E4%BA%A7ont%E5%92%8Cong%E8%BD%AC%E8%B4%A6))，if it exists，you needs to wait for the consensus node to pack and then query

   - If not, the transaction can be considered as failure and the transfer operation needs to be executed again.


   - If the transaction is not packaged for a long time, it may be due to the gas price being too low.

     ​

## 4. Java SDK Tutorials

Java SDK Tutorials: [Java SDK Tutorials](https://github.com/ontio/ontology-java-sdk/blob/master/docs/cn/sdk_get_start.md) 

### Account management

#### Do not use wallet management

##### Create account randomly

```java
com.github.ontio.account.Account acct = new com.github.ontio.account.Account(ontSdk.defaultSignScheme);
acct.serializePrivateKey();//Private key
acct.serializePublicKey();//Public key
acct.getAddressU160().toBase58();//base58 address
```

##### Create account based on private key

```java
com.github.ontio.account.Account acct0 = new com.github.ontio.account.Account(Helper.hexToBytes(privatekey0), ontSdk.defaultSignScheme);
com.github.ontio.account.Account acct1 = new com.github.ontio.account.Account(Helper.hexToBytes(privatekey1), ontSdk.defaultSignScheme);
com.github.ontio.account.Account acct2 = new com.github.ontio.account.Account(Helper.hexToBytes(privatekey2), ontSdk.defaultSignScheme);

```

#### Use wallet management

[Example](https://github.com/ontio/ontology-java-sdk/blob/master/src/main/java/demo/WalletDemo.java) 

```java

#### Create a batch of account in the wallet
ontSdk.getWalletMgr().createAccounts(10, "passwordtest");
ontSdk.getWalletMgr().writeWallet();

Create account randomly
AccountInfo info0 = ontSdk.getWalletMgr().createAccountInfo("passwordtest");

Create account based on private key
AccountInfo info = ontSdk.getWalletMgr().createAccountInfoFromPriKey("passwordtest","e467a2a9c9f56b012c71cf2270df42843a9d7ff181934068b4a62bcdd570e8be");

Get account
com.github.ontio.account.Account acct0 = ontSdk.getWalletMgr().getAccount(info.addressBase58,"passwordtest");

```

### Address generation

The address includes single-signature address and multi-signature address, and the generation method is the same as the NEO address.

```
single-signature address generation
String privatekey0 = "c19f16785b8f3543bbaf5e1dbb5d398dfa6c85aaad54fc9d71203ce83e505c07";
String privatekey1 = "49855b16636e70f100cc5f4f42bc20a6535d7414fb8845e7310f8dd065a97221";
String privatekey2 = "1094e90dd7c4fdfd849c14798d725ac351ae0d924b29a279a9ffa77d5737bd96";

//Generate account and get address
com.github.ontio.account.Account acct0 = new com.github.ontio.account.Account(Helper.hexToBytes(privatekey0), ontSdk.defaultSignScheme);
Address sender = acct0.getAddressU160();

//base58 address decode
sender = Address.decodeBase58("AVcv8YBABi9m6vH7faq3t8jWNamDXYytU2")；

//multi-signature address generation
Address recvAddr = Address.addressFromMultiPubKeys(2, acct1.serializePublicKey(), acct2.serializePublicKey());


```

| Method Name                  | Parameter                      | Parameter Description                       |
| :---------------------- | :------------------------ | :----------------------------- |
| addressFromMultiPubkeys | int m,byte\[\]... pubkeys | The minimum number of signatures (<=the number of public keys)，public key |


### ONT and ONG transfer

Example：[Example](https://github.com/ontio/ontology-java-sdk/blob/master/src/main/java/demo/MakeTxWithoutWalletDemo.java)

#### 1. Initialization

```
String ip = "http://polaris1.ont.io";
String rpcUrl = ip + ":" + "20336";
OntSdk ontSdk = OntSdk.getInstance();
ontSdk.setRpc(rpcUrl);
ontSdk.setDefaultConnect(wm.getRpc());

```

#### 2. Query

##### Query ONT, ONG Balance

```
ontSdk.getConnect().getBalance("AVcv8YBABi9m6vH7faq3t8jWNamDXYytU2");

View ONT information:
System.out.println(ontSdk.nativevm().ont().queryName());
System.out.println(ontSdk.nativevm().ont().querySymbol());
System.out.println(ontSdk.nativevm().ont().queryDecimals());
System.out.println(ontSdk.nativevm().ont().queryTotalSupply());

View ONG information:
System.out.println(ontSdk.nativevm().ong().queryName());
System.out.println(ontSdk.nativevm().ong().querySymbol());
System.out.println(ontSdk.nativevm().ong().queryDecimals());
System.out.println(ontSdk.nativevm().ong().queryTotalSupply());

```

##### Query whether the transaction is in the transaction pool

```
ontSdk.getConnect().getMemPoolTxState("d441a967315989116bf0afad498e4016f542c1e7f8605da943f07633996c24cc")


response: the transaction is in the transaction pool

{
    "Action": "getmempooltxstate",
    "Desc": "SUCCESS",
    "Error": 0,
    "Result": {
        "State":[
            {
              "Type":1,
              "Height":744,
              "ErrCode":0
            },
            {
              "Type":0,
              "Height":0,
              "ErrCode":0
            }
       ]
    },
    "Version": "1.0.0"
}

Or the transaction is not in the transaction pool

{
    "Action": "getmempooltxstate",
    "Desc": "UNKNOWN TRANSACTION",
    "Error": 44001,
    "Result": "",
    "Version": "1.0.0"
}

```

##### Query whether the transaction is successful

Query pushing content of a smart contract

```
ontSdk.getConnect().getSmartCodeEvent("d441a967315989116bf0afad498e4016f542c1e7f8605da943f07633996c24cc")


response:
{
    "Action": "getsmartcodeeventbyhash",
    "Desc": "SUCCESS",
    "Error": 0,
    "Result": {
        "TxHash": "20046da68ef6a91f6959caa798a5ac7660cc80cf4098921bc63604d93208a8ac",
        "State": 1,
        "GasConsumed": 0,
        "Notify": [
            {
                "ContractAddress": "ff00000000000000000000000000000000000001",
                "States": [
                    "transfer",
                    "T9yD14Nj9j7xAB4dbGeiX9h8unkKHxuWwb",
                    "TA4WVfUB1ipHL8s3PRSYgeV1HhAU3KcKTq",
                    1000000000
                ]
            }
        ]
    },
    "Version": "1.0.0"
}

```

You can use the block height to query a smart contract event, and the event transaction hash will be returned.

```
ontSdk.getConnect().getSmartCodeEvent(10)

response:
{
    "Action": "getsmartcodeeventbyheight",
    "Desc": "SUCCESS",
    "Error": 0,
    "Result": [
        "20046da68ef6a91f6959caa798a5ac7660cc80cf4098921bc63604d93208a8ac",
        "38e88c4f3e566737d45f25acbbfeaaebd226cc71aef16ba266c55bf6f8333966",
        "724c6f7645e489e9405e6a9745e89a27c13e3a8563b71e71197fc80fe94023ab",
        "923320009925c6468a483e5dad2989f590d21a9f8bc1230b8fc31e7459da32c8"
    ],
    "Version": "1.0.0"
}

```

#### The list of chain interaction interfaces

| No   |                    Main   Function                     |     Description      |
| ---- | :----------------------------------------------------: | :------------------: |
| 1    |       ontSdk.getConnect().getGenerateBlockTime()       |   Query VBFT block-out time   |
| 2    |           ontSdk.getConnect().getNodeCount()           |     Query the number of nodes     |
| 3    |            ontSdk.getConnect().getBlock(15)            |        Query block info        |
| 4    |          ontSdk.getConnect().getBlockJson(15)          |        Query block info        |
| 5    |       ontSdk.getConnect().getBlockJson("txhash")       |        Query block info        |
| 6    |         ontSdk.getConnect().getBlock("txhash")         |        Query block info        |
| 7    |          ontSdk.getConnect().getBlockHeight()          |     Query current block height     |
| 8    |      ontSdk.getConnect().getTransaction("txhash")      |       Query transaction       |
| 9    | ontSdk.getConnect().getStorage("contractaddress", key) |   Query smart contract storage   |
| 10   |       ontSdk.getConnect().getBalance("address")        |       Query balance       |
| 11   | ontSdk.getConnect().getContractJson("contractaddress") |     Query smart contract     |
| 12   |       ontSdk.getConnect().getSmartCodeEvent(59)        |   Query the event in the smart contract   |
| 13   |    ontSdk.getConnect().getSmartCodeEvent("txhash")     |   Query the event in the smart contract   |
| 14   |  ontSdk.getConnect().getBlockHeightByTxHash("txhash")  |   Query the block height by transaction hash   |
| 15   |      ontSdk.getConnect().getMerkleProof("txhash")      |    Get merkle proof    |
| 16   | ontSdk.getConnect().sendRawTransaction("txhexString")  |       Send transaction       |
| 17   |  ontSdk.getConnect().sendRawTransaction(Transaction)   |       Send transaction       |
| 18   |    ontSdk.getConnect().sendRawTransactionPreExec()     |    Send a pre-execution transaction    |
| 19   |  ontSdk.getConnect().getAllowance("ont","from","to")   |    Query Allowed Values    |
| 20   |        ontSdk.getConnect().getMemPoolTxCount()         | Query total transaction volumn in the transaction pool  |
| 21   |        ontSdk.getConnect().getMemPoolTxState()         | Query transaction status in the transaction pool |

#### 3. ONT transfer

##### Construct transfer transaction and send

```
// Transferee and payee address
Address sender = acct0.getAddressU160();
Address recvAddr = acct1;

// Multiple address generation
//Address recvAddr = Address.addressFromMultiPubKeys(2, acct1.serializePublicKey(), acct2.serializePublicKey());

// Construct a transfer transaction
long amount = 1000;
Transaction tx = ontSdk.nativevm().ont().makeTransfer(sender.toBase58(),recvAddr.toBase58(), amount,sender.toBase58(),30000,0);

// Sign a transaction
ontSdk.signTx(tx, new com.github.ontio.account.Account[][]{{acct0}});
//Signature scheme of multiple address
ontSdk.signTx(tx, new com.github.ontio.account.Account[][]{{acct1, acct2}});
//If the addresses of the transferee and the payer who pay the network fee are different, the payer’s signature needs to be added.

// Send a transaction
ontSdk.getConnect().sendRawTransaction(tx.toHexString());


```

| Method Name       | Parameter                                                         | Parameter Description                                                      |
| :----------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| makeTransfer | String sender，String recvAddr,long amount,String payer,long gaslimit,long gasprice | sender address, receiver address, amount, network fee payer address, gaslimit, gasprice |
| makeTransfer | State\[\] states,String payer,long gaslimit,long gasprice    | A transaction contains multiple transfers |

##### Multiple signatures 

If the addresses of the transferee and the payer who pay the network fee are different, the payer’s signature needs to be added.

```
// 1.Add single signature 
ontSdk.addSign(tx,acct0);

// 2.Add multiple signatures 
ontSdk.addMultiSign(tx,2,new com.github.ontio.account.Account[]{acct0,acct1});

```


##### One to multiple or multiple to multiple

1. Construct a transaction with multiple states
2. Signature
3. A transaction includes 1024 transfers at most

```
Address sender1 = acct0.getAddressU160();
Address sender2 = Address.addressFromMultiPubKeys(2, acct1.serializePublicKey(), acct2.serializePublicKey());
int amount = 10;
int amount2 = 20;

State state = new State(sender1, recvAddr, amount);
State state2 = new State(sender2, recvAddr, amount2);
Transaction tx = ontSdk.nativevm().ont().makeTransfer(new State[]{state1,state2},sender1.toBase58(),30000,0);

//The first transferee is a single-signature address, and the second transferee is a multiple-signature address
ontSdk.signTx(tx, new com.github.ontio.account.Account[][]{{acct0}});
ontSdk.addMultiSign(tx,2,new com.github.ontio.account.Account[]{acct1, acct2});

```

#### Use signature server to sign

- **Construct transaction and sign**

1. Construct a transaction, serialize a transaction, send a transaction to the signature server
2. The signature server receives the transaction, deserializes, checks the transaction, and adds the signature
3. Send transaction

```
//Send serialized transaction to signature server
Transaction tx = ontSdk.nativevm().ont().makeTransfer(sender.toBase58(),recvAddr.toBase58(), amount,sender.toBase58(),30000,0);
String txHex = tx.toHexString();

//The receiver deserializes the transaction and signs it
Transaction txRx = Transaction.deserializeFrom(Helper.hexToBytes(txHex));
//View transfer content in the transaction
System.out.println(Transfers.deserializeFrom(Contract.deserializeFrom(txRx.code).args).json());

//Sign
ontSdk.addSign(txRx,acct0);
```

- **Sign data**

[Example](https://github.com/ontio/ontology-java-sdk/blob/master/src/main/java/demo/SignatureDemo.java) 

```
com.github.ontio.account.Account acct = new com.github.ontio.account.Account(ontSdk.defaultSignScheme);

byte[] data = "12345".getBytes();
byte[] signature = ontSdk.signatureData(acct, data);

System.out.println(ontSdk.verifySignature(acct.serializePublicKey(), data, signature));

```



#### 4. ONG transfer

##### ONG transfer

The interface is similar to ONT:

```
ontSdk.nativevm().ong().makeTransfer...
```

##### Withdraw ONG

1. Check the balance of ONG
2. Create account
3. Construct transaction
4. Signature
5. Send transaction that withdraw ONG

```
//Query non-withdrawal ONG
String claimer = acct0.getAddressU160().toBase58();
sdk.nativevm().ong().unclaimOng(claimer);

//Claim ong，withdraw ONG
com.github.ontio.account.Account acct0 = new com.github.ontio.account.Account(Helper.hexToBytes(privatekey0), ontSdk.signatureScheme);

Transaction tx = sdk.nativevm().ong().makeClaimOng(claimer,claimer,10,claimer,30000,0);
sdk.signTx(tx, new com.github.ontio.account.Account[][]{{acct0}});

ontSdk.getConnect().sendRawTransaction(tx.toHexString());
```

| Method Name       | Parameter                                                         | Parameter Description                                                      |
| :----------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| makeClaimOng | String claimer,String to,long amount,String payer,long gaslimit,long gasprice | claimer，who to send，amount, network payer address，gaslimit，gasprice |


## 5. Distribute ONG to Users

The exchange can choose whether to distribute the ONG to users. The ONG is used to pay for the Ontology blockchain bookkeeping fees, network fees, and other service fees.

### What is ONG

The total number of ONG is 1 billion with a precision of 9. When the ONT transfer transaction occurs, the unlocked ONG will be authorized by the ONT contract to the transfer sender and receiver. The ONG quantity that the ONT holder can obtain is the percentage of the total amount of ONT owned by the ONT holder. If the transfer transaction has not been triggered, the ONG authorized to the ONT holder will be accumulated and will be issued at the time of the next transfer transaction. This part of the ONG needs to be manually withdrew into wallet address.

### Calculate the amount of ONG that can withdraw

The number of unlocked ONGs is determined by the time interval. The unlock rule is as follows: Unlocking ONG once every second. The number of unlocked ONG is not constant and the unlocked number is determined by ontology unlocked distribution curve. Ontology unlocked distribution curve interval is [5, 4, 3, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]. Approximately every 31536000 blocks, the unlocked value of ONG will be changed. After about 18 years, all ONGs will be unlocked.

**ONG locked list**
![ong](https://s15.postimg.cc/bwnan7anv/image.png)

### Distribute ONG to users

View locked ONG Balances via the CLI：```./ontology asset unboundong <address|index|label>```

```
$ ./ontology asset unboundong 1
Unclaim Ong:
  Account:TA5zt4PrSzjWA7DaVHVw2nhxH5ZY9uQiGq
  ONG:23698.8755104

```

Withdraw unlocked ONG via CLI：```./ontology asset withdrawong <address|index|label>```

--wallet, -w  
Wallet specifies the wallet path of withdrawal account. The default value is: "./wallet.dat".

--gasprice  
The gasprice parameter specifies the gas price of the transfer transaction. The gas price of the transaction cannot be less than the lowest gas price set by node's transaction pool, otherwise the transaction will be rejected. The default value is 0. When there are transactions that are queued for packing into the block in the transaction pool, the transaction pool will deal with transactions according to the gas price and transactions with high gas prices will be prioritized. 

--gaslimit  
The gaslimit parameter specifies the gas limit of the transfer transaction. The gas limit of the transaction cannot be less than the minimum gas limit set by the node's transaction pool, otherwise the transaction will be rejected. Gasprice * gaslimit is actual ONG costs. The default value is 30000.

```
$ ./ontology asset withdrawong 1
Password:
Claim Ong:
  Account:TA5zt4PrSzjWA7DaVHVw2nhxH5ZY9uQiGq
  Amount:23698.8755104
  TxHash:c696033f1589a88c7b849dbd2ad0c13a9ca695c3220e4f846f9b1096d0972b80

Tip:
  Using './ontology info status c696033f1589a88c7b849dbd2ad0c13a9ca695c3220e4f846f9b1096d0972b80' to query transaction status

```

Same as user deposit，you can use ```./ontology info status c696033f1589a88c7b849dbd2ad0c13a9ca695c3220e4f846f9b1096d0972b80``` to query the result of the ONG withdrawal.

Example:

Assuming that all addresses of the exchange are in one wallet, the following figure shows the process and calculation formula about how an exchange distributes ONG to a user A:

![ong](./images/ong1.png)

### Users withdraw ONG

The process of withdrawing the ONG is the same as the process of withdrawing the ONT, just specify the asset parameter as ong:

```
$ ./ontology asset transfer --asset ong --from TA5zt4PrSzjWA7DaVHVw2nhxH5ZY9uQiGq --to TA8MoGmzS4T6g3T1CMGEVFiNGkZnn7ixw9 --amount 100
Password:
Transfer ONG
  From:TA5zt4PrSzjWA7DaVHVw2nhxH5ZY9uQiGq
  To:TA8MoGmzS4T6g3T1CMGEVFiNGkZnn7ixw9
  Amount:100
  TxHash:a77f84040700f0a68d0ce401f6eae5786744b56061c1888b5848f4dc46648b4f

Tip:
  Using './ontology info status a77f84040700f0a68d0ce401f6eae5786744b56061c1888b5848f4dc46648b4f' to query transaction status

```

Use Java SDK to withdraw ONG，please refer to[Java SDK:ONG transfer](https://github.com/ontio/ontology-java-sdk/blob/master/docs/cn/sdk_get_start.md#24-ong%E8%BD%AC%E8%B4%A6)

## 6. Signature service

[Ontology Signature Server Tutorials](./Ontology+Signature-Server-Tutorials.md)
